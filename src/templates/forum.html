<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>論壇</title>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script>
    <script src="/static/basic.js?dummy=3"></script>
</head>
<body>
    <form id="new-post" action="javascript:;" onsubmit="return SubmitNewPost(this);">
        <input field="title" type="text" placeholder="標題"><br>
        <textarea field="content" cols="30" rows="10"></textarea>

        <input type="submit" value="送出">
    </form>

    <div data-bind="foreach: visiblePosts">
        <div data-bind="html: formated()"></div>
    </div>

    <script>
        function SubmitNewPost(formEle) {
            var data = GetFormFieldsData(formEle);

            if (data == null) {
                alert("請填寫完整");
                return;
            }
            else {
                Post("/rest/forum/post", data, function (msg) {
                    console.log(msg);
                }, function (err) {
                    console.log(err);
                })
            }
        }

        var ForumPost = function (data) {
            var self = this;

            this.id = data.id;
            this.title = data.title;
            this.content = data.content;
            this.cover_img = data.cover_img;
            this.topic = data.topic;
            this.views_count = data.views_count;
            this.create_at = ParseDatetime(data.create_at);

            this.formated = function () {
                return `<h3>${self.title}</h3>${self.content}<br>${self.create_at.strftime("%Y/%m/%d %H:%M:%S")}`;
            }
        }

        function AppViewModel() {
            var self = this;

            this.posts = ko.observableArray([]);
            this.isLogined = ko.observable(GetCookie("key") != "");

            this.visiblePosts = ko.computed(function () {
                return self.posts();
            }, this);


            this.FetchAllForumPost = function () {
                Get("/rest/forum/post", {}, function (msg) {
                    console.log(msg);
                    self.posts.removeAll();

                    for (row of msg.data) {
                        self.posts.push(new ForumPost(row));
                    }
                }, function () {});
            }
        }

        var viewmodel = new AppViewModel();
        ko.applyBindings(viewmodel);
        viewmodel.FetchAllForumPost();
    </script>
</body>
</html>